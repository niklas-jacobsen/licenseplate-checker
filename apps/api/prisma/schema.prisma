generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CityAbbreviation {
  id   String @id @db.VarChar(3)
  name String

  websiteUrl     String?
  allowedDomains String[]

  isPublic Boolean @default(true)

  licenseplateChecks LicenseplateCheck[]
  workflows          Workflow[]
}

model Workflow {
  id          String  @id @default(cuid())
  name        String
  description String?

  definition Json

  isPublished Boolean @default(false)

  // Relations
  cityId String
  city   CityAbbreviation @relation(fields: [cityId], references: [id])

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  executions WorkflowExecution[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  licenseplateChecks LicenseplateCheck[]

  @@unique([cityId, name, authorId])
}

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String

  // Profile info
  salutation   Salutation?
  firstname    String?
  lastname     String?
  birthdate    DateTime?
  street       String?
  streetNumber String?
  zipcode      Int?
  city         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  licenseplateChecks LicenseplateCheck[]
  createdWorkflows   Workflow[]
}

model LicenseplateCheck {
  id String @id @default(cuid())

  cityId  String @db.VarChar(3)
  letters String @db.VarChar(2)
  numbers Int

  userId String

  status        CheckStatus @default(UNCHECKED)
  lastCheckedAt DateTime?

  // Scheduling
  cron String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User             @relation(fields: [userId], references: [id])
  city CityAbbreviation @relation(fields: [cityId], references: [id])

  workflowId String?
  workflow   Workflow? @relation(fields: [workflowId], references: [id])

  // History of automation runs
  executions WorkflowExecution[]

  @@unique([cityId, letters, numbers, userId])
}

model WorkflowExecution {
  id String @id @default(cuid())

  status ExecutionStatus @default(PENDING)
  logs   Json?
  result Json?

  duration    Int? // in ms
  errorNodeId String?
  inngestId   String?

  startedAt  DateTime  @default(now())
  finishedAt DateTime?

  // Relations
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id])

  checkId String?
  check   LicenseplateCheck? @relation(fields: [checkId], references: [id])

  @@index([workflowId, startedAt])
}

// Enumerators

enum CheckStatus {
  UNCHECKED
  AVAILABLE
  RESERVED
  NOT_AVAILABLE
  ERROR_DURING_CHECK
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum Salutation {
  HERR
  FRAU
  FIRMA
  VEREIN
  JURISTISCHE_PERSON
}
